---
title: "Model Fidelity"
author: "Timo Kelder"
date: "June 4, 2020"
output: github_document 
---

```{r eval=FALSE, include=FALSE}
Rscript -e "rmarkdown::render('2.3Fidelity.Rmd')"
```

In this notebook, we assess the model fidelity of the SEAS5 UNSEEN ensemble over the UK compared to EOBS. We start by bootstrapping  the ensemble and then compare the extreme value distributions for both. For specifics, please see the paper.

## Import data and packages

```{r}
dir='C:/Users/Timo/OneDrive - Loughborough University/GitHub/UNSEEN-open/Data'

library('ncdf4')
library('ggplot2')
library('plyr')
library("tidyverse")

library(moments)
library(extRemes)
library("ggpubr")
```

### Load the data
This data is downloaded from CDS. see the Notebooks of the first step of the workflow. We load the netcdf of SEAS5 data, that contains February precipitation forecasts for all 25 members over 35 years (1981-2016) and and 5 leadtimes. 
```{r}
SEAS5_UK_weighted_nc = nc_open(paste0(dir,'/SEAS5_UK_weighted.nc')) # Open the netcdf file
SEAS5_UK_weighted_array = ncvar_get(SEAS5_UK_weighted_nc) # and get the values
dim(SEAS5_UK_weighted_array) ## Show the dimensions of the netcdf file
head(SEAS5_UK_weighted_array)
```
The dimnames do not get loaded from the netcdf created with Xarray. Here I set the dimnames. The dimensions are:

- Member: 0-24
- Year: 1982:2016
- Leadtime: 2:6

```{r}
dimnames(SEAS5_UK_weighted_array)
dimnames(SEAS5_UK_weighted_array) = list(as.character(0:24),1982:2016,as.character(2:6))
names(dimnames(SEAS5_UK_weighted_array)) <- c('Member', 'Year','Leadtime')
head(SEAS5_UK_weighted_array)

```

R works mostly in dataframes rather than arrays (e.g. ggplot and tidyverse). Therefore, we convert the array into a dataframe.

```{r}
SEAS5_UK_weighted_df = adply(SEAS5_UK_weighted_array, 1:3) ## Convert the array to a data frame. Split up data by all dimensions (1:3)  
head(SEAS5_UK_weighted_df)
```

Check if the conversion was successful: select member = 0, year = 1981 and Leadtime = 2. 
```{r}
SEAS5_UK_weighted_array['0','1982','2']
SEAS5_UK_weighted_df[1,,]
```

And the EOBS observations:

```{r}
EOBS_UK_weighted = read.csv(paste0(dir,'/EOBS_UK_weighted.csv'))

EOBS_UK_weighted_nc = nc_open(paste0(dir,'/EOBS_UK_weighted.nc')) 
EOBS_UK_weighted_array = ncvar_get(EOBS_UK_weighted_nc) # and get the values
dim(EOBS_UK_weighted_array) ## Show the dimensions of the netcdf file
dimnames(EOBS_UK_weighted_array) = list(as.character(1950:2020)) #set the dimnames as the years 1950-2020
```

```{r}
model_data = SEAS5_UK_weighted_df
obs_data = EOBS_UK_weighted

p1=ggplot()+
  geom_boxplot(data=model_data,mapping = aes(x=Year,y=V1,group=Year,fill='SEAS5'),alpha=0.3 )+ ##Seas5 color is defined manually
  geom_point(data=obs_data,aes(x=time,y = X0,col='ERA5'),shape=4,size=2,stroke=1.5)+
  theme_classic()+
  scale_fill_manual(name=NULL,values=c("SEAS5"="black"))+ ##Here SEAS5 color is defined
  scale_colour_manual(name=NULL,values=c("ERA5"="blue"))+ ## And ERA5 color
  ylab('NDJ precipitation extremes (mm/day)')+
  ggtitle('UK')+
  theme(legend.position = c(.95, .02),
      legend.justification = c("right", "bottom"),
      legend.spacing.y = unit(-0.2, 'cm'),
      legend.title = element_blank())+#,
      # text=element_text(size=7),
      #   axis.text = element_text(size=7))+
  guides(color = guide_legend(order=1),
         fill = guide_legend(order=2))
    
p2=ggplot()+
  geom_boxplot(data=SEAS5_timeseries_Region2_all,mapping = aes(x=year,y=precip,group=year,fill='SEAS5'),alpha=0.3 )+ ##Seas5 color is defined manually
  geom_point(data=ERA5_timeseries_Region2,aes(x=year,y = precip,col='ERA5'),shape=4,size=2,stroke=1.5)+
  theme_classic()+
  scale_fill_manual(name=NULL,values=c("SEAS5"="black"))+ ##Here SEAS5 color is defined
  scale_colour_manual(name=NULL,values=c("ERA5"="blue"))+ ## And ERA5 color
  ylab('NDJ precipitation extremes (mm/day)')+
  ggtitle('North Svalbard')+
  theme(legend.position = c(.95, .02),
      legend.justification = c("right", "bottom"),
      legend.spacing.y = unit(-0.2, 'cm'),
      legend.title = element_blank())+#,
      # text=element_text(size=7),
      #   axis.text = element_text(size=7))+
  guides(color = guide_legend(order=1),
         fill = guide_legend(order=2))
p1
p2

ggarrange(p2,p1,
            labels = c("a", "b"),
            font.label = list(#size = 7, 
                              color = "black", face ="bold", family = NULL),
            ncol = 1, nrow = 2)%>%
      ggsave(filename = "graphs/SEAS5_ERA5_timeseries3.pdf",width =180,height = 180, units='mm',dpi=300)
  # 
```
